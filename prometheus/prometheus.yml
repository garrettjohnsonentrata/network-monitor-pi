# =============================================================================
# Prometheus Configuration for Pi Network Tester
# Optimized for Raspberry Pi 3 Model B (1GB RAM)
# =============================================================================

global:
  scrape_interval: 15s
  evaluation_interval: 15s
  external_labels:
    monitor: 'pi-network-tester'

rule_files:
  - /etc/prometheus/alerts.yml

alerting:
  alertmanagers:
    - static_configs:
        - targets: ['alertmanager:9093']

# =============================================================================
# Scrape Configurations
# =============================================================================
scrape_configs:
  # ---------------------------------------------------------------------------
  # Prometheus Self-Monitoring
  # ---------------------------------------------------------------------------
  - job_name: 'prometheus'
    static_configs:
      - targets: ['localhost:9090']
        labels:
          instance: 'prometheus'

  # ---------------------------------------------------------------------------
  # Node Exporter - Raspberry Pi System Metrics
  # ---------------------------------------------------------------------------
  - job_name: 'node'
    static_configs:
      - targets: ['node-exporter:9100']
        labels:
          instance: 'raspberry-pi'

  # ---------------------------------------------------------------------------
  # Blackbox Exporter - ICMP Ping Monitoring
  # Uses file_sd_configs for dynamic target discovery
  # ---------------------------------------------------------------------------
  - job_name: 'blackbox-icmp'
    metrics_path: /probe
    params:
      module: [icmp]
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/icmp_targets.json'
        refresh_interval: 1m
    relabel_configs:
      # Pass the target to the blackbox exporter
      - source_labels: [__address__]
        target_label: __param_target
      # Keep the original target as a label
      - source_labels: [__param_target]
        target_label: target
      # Replace the address with blackbox exporter address
      - target_label: __address__
        replacement: blackbox:9115

  # ---------------------------------------------------------------------------
  # Blackbox Exporter - DNS Monitoring
  # ---------------------------------------------------------------------------
  - job_name: 'blackbox-dns'
    metrics_path: /probe
    params:
      module: [dns]
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/dns_targets.json'
        refresh_interval: 1m
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: target
      - target_label: __address__
        replacement: blackbox:9115

  # ---------------------------------------------------------------------------
  # Blackbox Exporter - TCP Connect (Game Servers)
  # ---------------------------------------------------------------------------
  - job_name: 'blackbox-tcp'
    metrics_path: /probe
    params:
      module: [tcp_connect]
    file_sd_configs:
      - files:
          - '/etc/prometheus/targets/game_servers.json'
        refresh_interval: 5m
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: target
      - target_label: __address__
        replacement: blackbox:9115

  # ---------------------------------------------------------------------------
  # Speedtest Exporter - Bandwidth Monitoring
  # Scrape interval set to 1 hour to avoid bandwidth caps
  # ---------------------------------------------------------------------------
  - job_name: 'speedtest'
    scrape_interval: 1h
    scrape_timeout: 120s
    static_configs:
      - targets: ['speedtest:9798']
        labels:
          instance: 'speedtest'

  # ---------------------------------------------------------------------------
  # Alertmanager - Alert Routing and Notifications
  # ---------------------------------------------------------------------------
  - job_name: 'alertmanager'
    static_configs:
      - targets: ['alertmanager:9093']
        labels:
          instance: 'alertmanager'

  # ---------------------------------------------------------------------------
  # vnStat Exporter - Bandwidth Usage Metrics
  # ---------------------------------------------------------------------------
  - job_name: 'vnstat'
    scrape_interval: 1m
    static_configs:
      - targets: ['vnstat-exporter:9176']
        labels:
          instance: 'vnstat'

  # ---------------------------------------------------------------------------
  # Blackbox Exporter Self-Monitoring
  # ---------------------------------------------------------------------------
  - job_name: 'blackbox'
    static_configs:
      - targets: ['blackbox:9115']
        labels:
          instance: 'blackbox-exporter'
